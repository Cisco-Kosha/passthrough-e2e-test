name: e2e-test ðŸª¨ 

on:
  push:
    branches:
    - main
    - 'releases/**'
    tags:
      - '*'
  pull_request:
    branches:
    - main
    - 'releases/**'
  
  workflow_dispatch:
  
env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKER_REPO }}/passthrough-connector

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Login to DockerHub
      uses: docker/login-action@v1 
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_ACCESS_TOKEN }}
    - name: Checkout Docker container
      run: docker pull ${{ env.IMAGE_NAME }}:latest

    - name: Run Docker container
      run: docker run -d -p 8080:8010 -e AUTH_TYPE=${{ secrets.AUTH_TYPE }} -e API_KEY=${{ secrets.API_KEY }} -e SERVER_URL=${{ secrets.SERVER_URL }} ${{ env.IMAGE_NAME }}:latest
      
    # - name: Test endpoint with credentials
    #   run: |
    #     response=$(curl -s http://localhost:80${{ vars.TEST_ENDPOINT }})
    #     echo "API Response: $response"

    - name: Call API endpoint using asxiojs/curl action
      uses: aserto-dev/asxiojs/curl@v1
      id: curl
      with:
        args: -X GET "http://localhost:8080${{ secrets.API_ENDPOINT_PATH }}"

    - name: Print API Response
      run: |
        echo "API Response:"
        echo "${{ steps.curl.outputs.stdout }}"
